<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGPA & CGPA Calculator</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>SGPA & CGPA Calculator</h1>
    <p>Paste tab-separated or comma-separated data below (edit or replace the default data):</p>
    <textarea id="dataInput">
#	University Id	Student Name	Course Code	Course Name	Grade	Grade Point	Credits	Promotion	Reg Academic Year	Reg Sem
    </textarea>
    <br>
    <button onclick="calculateGPA()">Calculate</button>
    <a href="graph.html" class="trend-button">View SGPA Trend</a>
    <div id="error"></div>
    <div id="cgpa-result"><h2>Overall CGPA: <span id="cgpa-value">N/A</span></h2></div>
    <div id="result"></div>
    <div id="non-promoted-subjects"><h2>Non-Promoted Subjects (Promotion ≠ P)</h2></div>
    <div id="course-details"></div>

    <script>
        // Grade to grade point mapping
        const gradePoints = {
            'O': 10,
            'A+': 9,
            'A': 8,
            'B+': 7,
            'B': 6,
            'C+': 5,
            'C': 4,
            'P': 0 // Ignored for GPA calculations
        };

        function parseData(inputText) {
            const lines = inputText.trim().split('\n');
            const headers = lines[0].split('\t').map(h => h.trim());
            const requiredColumns = ['Reg Academic Year', 'Reg Sem', 'Credits', 'Grade', 'Course Name', 'University Id', 'Course Code', 'Promotion'];
            
            // Check if all required columns are present
            if (!requiredColumns.every(col => headers.includes(col))) {
                throw new Error('Input data must include columns: ' + requiredColumns.join(', '));
            }

            const data = [];
            let universityId = null;
            const courseSet = new Set(); // To track unique courses per semester

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split('\t').map(v => v.trim());
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });

                // Validate university ID
                if (universityId === null && row['University Id']) {
                    universityId = row['University Id'];
                } else if (row['University Id'] !== universityId) {
                    throw new Error(`University ID mismatch at row ${i + 1}. Expected "${universityId}", found "${row['University Id']}". All rows must have the same University ID.`);
                }

                // Check for duplicate courses (same Course Code, Academic Year, and Semester)
                const courseKey = `${row['Course Code']}_${row['Reg Academic Year']}_${row['Reg Sem']}`;
                if (courseSet.has(courseKey)) {
                    throw new Error(`Duplicate course entry found at row ${i + 1}: Course Code "${row['Course Code']}" in ${row['Reg Academic Year']} ${row['Reg Sem']}.`);
                }
                courseSet.add(courseKey);

                data.push(row);
            }

            // Check if any valid university ID was found
            if (universityId === null) {
                throw new Error('No valid University ID found in the data.');
            }

            return data;
        }

        function calculateGPA() {
            const dataInput = document.getElementById('dataInput').value;
            const errorDiv = document.getElementById('error');
            const cgpaResultDiv = document.getElementById('cgpa-value');
            const resultDiv = document.getElementById('result');
            const courseDetailsDiv = document.getElementById('course-details');
            const nonPromotedDiv = document.getElementById('non-promoted-subjects');
            errorDiv.innerHTML = '';
            cgpaResultDiv.innerHTML = 'N/A';
            resultDiv.innerHTML = '';
            courseDetailsDiv.innerHTML = '';
            nonPromotedDiv.innerHTML = '<h2>Non-Promoted Subjects (Promotion ≠ P)</h2>';

            try {
                if (!dataInput.trim()) {
                    errorDiv.innerHTML = 'Please provide data in the text area.';
                    return;
                }

                const jsonData = parseData(dataInput);

                // Group data by academic year and semester
                const years = {};
                jsonData.forEach(row => {
                    const year = row['Reg Academic Year'] || 'Unknown Year';
                    const semester = row['Reg Sem'] || 'Unknown Sem';
                    const key = `${year} ${semester}`;
                    if (!years[year]) years[year] = {};
                    if (!years[year][semester]) years[year][semester] = [];
                    years[year][semester].push(row);
                });

                let totalCredits = 0; // Earned credits (valid grades)
                let totalRegisteredCredits = 0; // All registered credits
                let totalGradePoints = 0;
                let tableHTML = '<table><tr><th>Academic Year</th><th>Semester</th><th>SGPA</th><th>Earned Credits</th><th>Registered Credits</th></tr>';
                let courseDetailsHTML = '<h2>Course Details</h2>';
                let nonPromotedHTML = '<table><tr><th>Academic Year</th><th>Semester</th><th>Course Code</th><th>Course Name</th><th>Grade</th><th>Credits</th><th>Promotion</th></tr>';
                const chartData = { labels: [], sgpas: [], yearTotals: {}, yearCredits: {}, yearRegisteredCredits: {} };

                // Track non-promoted subjects
                let hasNonPromoted = false;

                // Calculate SGPA, earned credits, registered credits, and collect non-promoted subjects
                for (const year in years) {
                    let yearCredits = 0;
                    let yearRegisteredCredits = 0;
                    let yearGradePoints = 0;

                    for (const semester in years[year]) {
                        let semesterCredits = 0;
                        let semesterRegisteredCredits = 0;
                        let semesterGradePoints = 0;
                        courseDetailsHTML += `<h3>${year} ${semester}</h3><ul>`;

                        years[year][semester].forEach(course => {
                            const credits = parseFloat(course['Credits']) || 0;
                            const grade = course['Grade']?.toUpperCase();
                            const courseName = course['Course Name'] || 'Unknown Course';
                            const promotion = course['Promotion'] || 'N/A';

                            // Add to registered credits (all valid credit values)
                            if (!isNaN(credits)) {
                                semesterRegisteredCredits += credits;
                            }

                            // Add to course details
                            courseDetailsHTML += `<li>${courseName}: Grade=${grade || 'N/A'}, Credits=${credits}, Grade Point=${gradePoints[grade] || 'N/A'}</li>`;

                            // Add to non-promoted subjects table if Promotion is not 'P'
                            if (promotion !== 'P' && promotion !== '') {
                                hasNonPromoted = true;
                                nonPromotedHTML += `<tr><td>${year}</td><td>${semester}</td><td>${course['Course Code']}</td><td>${courseName}</td><td>${grade || 'N/A'}</td><td>${credits}</td><td>${promotion}</td></tr>`;
                            }

                            // Only include credits with valid grades for GPA calculation
                            if (!isNaN(credits) && credits > 0 && grade in gradePoints) {
                                semesterCredits += credits;
                                semesterGradePoints += credits * gradePoints[grade];
                            }
                        });

                        courseDetailsHTML += `</ul><p><b>Semester Summary:</b> Earned Credits=${semesterCredits}, Registered Credits=${semesterRegisteredCredits}</p>`;

                        if (semesterCredits > 0) {
                            const sgpa = (semesterGradePoints / semesterCredits).toFixed(2);
                            tableHTML += `<tr><td>${year}</td><td>${semester}</td><td>${sgpa}</td><td>${semesterCredits}</td><td>${semesterRegisteredCredits}</td></tr>`;
                            chartData.labels.push(`${year} ${semester}`);
                            chartData.sgpas.push(parseFloat(sgpa));
                            yearCredits += semesterCredits;
                            yearRegisteredCredits += semesterRegisteredCredits;
                            yearGradePoints += semesterGradePoints;
                            totalCredits += semesterCredits;
                            totalRegisteredCredits += semesterRegisteredCredits;
                            totalGradePoints += semesterGradePoints;
                        } else {
                            tableHTML += `<tr><td>${year}</td><td>${semester}</td><td>N/A</td><td>${semesterCredits}</td><td>${semesterRegisteredCredits}</td></tr>`;
                            chartData.labels.push(`${year} ${semester}`);
                            chartData.sgpas.push(0);
                        }
                    }

                    if (yearCredits > 0) {
                        chartData.yearTotals[year] = (yearGradePoints / yearCredits).toFixed(2);
                        chartData.yearCredits[year] = yearCredits;
                        chartData.yearRegisteredCredits[year] = yearRegisteredCredits;
                    }
                }

                // Finalize tables
                const cgpa = totalCredits > 0 ? (totalGradePoints / totalCredits).toFixed(2) : 'N/A';
                cgpaResultDiv.innerHTML = cgpa;
                tableHTML += `<tr><td colspan="2"><b>Total</b></td><td><b>${cgpa}</b></td><td><b>${totalCredits}</b></td><td><b>${totalRegisteredCredits}</b></td></tr>`;
                tableHTML += '<tr><th colspan="5">Yearly SGPA</th></tr>';
                for (const year in chartData.yearTotals) {
                    tableHTML += `<tr><td>${year}</td><td>All Semesters</td><td>${chartData.yearTotals[year]}</td><td>${chartData.yearCredits[year]}</td><td>${chartData.yearRegisteredCredits[year]}</td></tr>`;
                }
                tableHTML += '</table>';

                // Finalize non-promoted subjects table
                nonPromotedHTML += '</table>';
                if (!hasNonPromoted) {
                    nonPromotedHTML = '<p>No subjects found with Promotion status other than P.</p>';
                }

                // Update HTML content
                resultDiv.innerHTML = tableHTML;
                courseDetailsDiv.innerHTML = courseDetailsHTML;
                nonPromotedDiv.innerHTML += nonPromotedHTML;

                // Store chart data in sessionStorage for graph.html
                sessionStorage.setItem('chartData', JSON.stringify({
                    labels: chartData.labels,
                    sgpas: chartData.sgpas
                }));
            } catch (error) {
                errorDiv.innerHTML = 'Error processing data: ' + error.message;
            }
        }
    </script>
</body>
</html>
